
import type { Metadata } from 'next'
import dynamic from 'next/dynamic';
import {
  ClerkProvider,
  SignedIn,
  UserButton,
  OrganizationSwitcher,
} from '@clerk/nextjs'
import type { Appearance } from '@clerk/types';
import { customAppearance, userButtonAppearance } from '@/constants/clerk-configuration';
import User from '@/lib/models/user.model';

import LeftSidebar from "@/components/shared/LeftSidebar";
import RightSidebar from "@/components/shared/RightSidebar";
import Topbar from "@/components/shared/Topbar";

import '../globals.css'
import { Geist } from 'next/font/google'
import { Roboto } from 'next/font/google';
import { currentUser } from '@clerk/nextjs/server';
import { UploadErrorBoundary } from '@/components/Error-Boundary';
import { fetchUser } from '@/lib/actions/user.actions';
import { Suspense } from 'react';
import FeedSkeleton from '@/components/skeletons/FeedSkeleton';
import { redirect } from 'next/navigation';


// META DATA & FONT STAFF -- META DATA & FONT STAFF - META DATA & FONT STAFF

const geist = Geist({
  subsets: ['latin'], 
  variable : '--font-geist'
})
const roboto = Roboto({
  subsets: ['latin'], 
  weight: ['400', '600',],
  display: 'swap', // RECOMMENDED for performance
  
  variable: '--font-roboto', 
});

  export const metadata: Metadata = {
    title: '---- MY NExT JS APP  -----',
    description: 'Generated by create next app',
  }

  export default async function  RootLayout ({
    children,
  }: Readonly<{
    children: React.ReactNode
  }>) {

  // CLERK APPEARACNES --- CLERK APPEARACNES 
    const clerkUser = await currentUser();
    if (!clerkUser) return null;
  const userInfo = await fetchUser(clerkUser.id);
  const userImage = userInfo?.image || clerkUser.imageUrl;
  
  const isFirstTime = !!clerkUser?.publicMetadata?.isFirstTimeUser;
  
  customAppearance as Appearance

  // DYNAMIC IMPORTS ! DYNAMIC IMPORTS ! DYNAMIC IMPORTS !
  const DynamicChat  = dynamic(() => 
  import ('@/components/cards/Chats'),
  { loading: () => <p>Loading</p> })

  const DynamicCall = dynamic(() => 
    import ('./call'), {
     loading: () => <p>Loading</p>
  })

  const DynamicNotification = dynamic(() => 
    import ('./notification'), {
     loading: () => <p>Loading</p>
  })


  return (
    <UploadErrorBoundary>
    <ClerkProvider
     appearance= {customAppearance}
     >
      <html lang="en" className={`h-screen ${geist.className} ${roboto.className}`} >
        <body className={`antialiased mx-8 h-full flex flex-col gap-0 justify-between text-gray-900`} >
          <nav className="flex px-8 rounded-md justify-between z-50
          bg-gradient-to-tr from-gray-900 via-gray-800 to-gray-700
           text-white shadow-[0_8px_30px_rgb(0,0,0,0.12)] brightness-100 ">
            <Topbar/>
            <p className='font-black self-center'>THIS IS INSIDE IN THE ROOT LAYOUT 
              and TOPBAR</p>
            {/* <OrganizationProfile /> */}
            <OrganizationSwitcher />

            <DynamicCall />
            <DynamicNotification />
            
            {/* SIGNED USER PROFILE */}
            <SignedIn>
              <UserButton appearance={userButtonAppearance}/>
            </SignedIn>
          </nav>

        <main className='flex flex-1 justify-between'>
          <LeftSidebar userDBImage={userImage}/>
  
          {children}

        <RightSidebar isFirstTime={isFirstTime}>
          <Suspense>
            <DynamicChat />
          </Suspense>
        </RightSidebar>

      </main>
        </body>
      </html>
    </ClerkProvider>
  </UploadErrorBoundary>
  )
}